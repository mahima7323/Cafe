<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Items Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <%- include('partials/navbar') %>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Items Management</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                <i class="fas fa-plus"></i> Add Item
            </button>
        </div>

        <div class="card">
            <div class="card-body">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th class="text-primary fw-bold">Name</th>
                            <th class="text-primary fw-bold">Category</th>
                            <th class="text-primary fw-bold">Subcategory</th>
                            <th class="text-primary fw-bold">Price</th>
                            <th class="text-primary fw-bold">Image</th>
                            <th class="text-primary fw-bold">Status</th>
                            <th class="text-primary fw-bold">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <% items.forEach(item => { %>
                            <tr>
                                <td><%= item.name %></td>
                                <td><%= item.category_name %></td>
                                <td><%= item.subcategory_name %></td>
                                <td>₹ <%= Number(item.price).toFixed(2) %></td>
                                <td>
                                    <% if (item.image && item.image.trim()) { %>
                                        <img src="<%= item.image.startsWith('/') ? item.image : ('/uploads/items/' + item.image) %>"
                                             alt="<%= item.name %>" style="max-width:80px; max-height:80px; object-fit:cover;"
                                             onerror="this.onerror=null; this.src='/images/placeholder.png'">
                                    <% } else { %>
                                        <span class="text-muted">No image</span>
                                    <% } %>
                                </td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input item-status-toggle" type="checkbox" data-id="<%= item.id %>" <%= item.status === 'available' ? 'checked' : '' %>>
                                        <label class="form-check-label"><%= item.status %></label>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-warning edit-item" data-id="<%= item.id %>" data-name="<%= item.name %>" data-subcategory="<%= item.subcategory_id %>" data-price="<%= item.price %>" data-description="<%- (item.description||'').replace(/"/g,'&quot;') %>"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-danger delete-item" data-id="<%= item.id %>"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Item Modal -->
    <div class="modal fade" id="addItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Add Item</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="addItemForm" enctype="multipart/form-data" onsubmit="return false" novalidate>
                        <div class="mb-3">
                            <label class="form-label">Subcategory</label>
                            <select class="form-select" name="subcategory_id" required>
                                <option value="">Select Subcategory</option>
                                <% subcategories.forEach(sc => { %>
                                    <option value="<%= sc.id %>"><%= sc.name %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" min="0" class="form-control" name="price" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image</label>
                            <input type="file" class="form-control" name="image" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" id="saveItem" class="btn btn-primary">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Edit Item Modal -->
    <div class="modal fade" id="editItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Item</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="editItemForm" enctype="multipart/form-data" onsubmit="return false" novalidate>
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label class="form-label">Subcategory</label>
                            <select class="form-select" name="subcategory_id" required>
                                <option value="">Select Subcategory</option>
                                <% subcategories.forEach(sc => { %>
                                    <option value="<%= sc.id %>"><%= sc.name %></option>
                                <% }) %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" min="0" class="form-control" name="price" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image</label>
                            <input type="file" class="form-control" name="image" accept="image/*">
                        </div>
                    </form>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" id="updateItem" class="btn btn-primary">Update</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function normalizeItemImg(src){
            if(!src) return '';
            return src.startsWith('/') ? src : `/uploads/items/${src}`;
        }

        async function createItem(e){
            if(e) e.preventDefault();
            const form = document.getElementById('addItemForm');
            const fd = new FormData(form);
            const res = await fetch('/admin/items',{method:'POST', body: fd});
            const data = await res.json();
            if(!data.success) return alert(data.error||'Failed to add item');
            const it = data.item || {};
            const tbody = document.querySelector('table tbody');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                
                <td>${it.name ?? fd.get('name')}</td>
                <td>${it.category_name ?? ''}</td>
                <td>${it.subcategory_name ?? ''}</td>
                <td>₹ ${(it.price ?? fd.get('price')).toString()}</td>
                <td>${it.image ? `<img src="${normalizeItemImg(it.image)}" alt="${it.name}" style="max-width:80px; max-height:80px; object-fit:cover;" onerror="this.onerror=null; this.src='/images/placeholder.png'">` : '<span class="text-muted">No image</span>'}</td>
                <td><div class="form-check form-switch"><input class="form-check-input item-status-toggle" type="checkbox" data-id="${it.id}" ${it.status==='available'?'checked':''}><label class="form-check-label">${it.status||'available'}</label></div></td>
                <td><button class="btn btn-sm btn-warning edit-item" data-id="${it.id}" data-name="${it.name}" data-subcategory="${it.subcategory_id}" data-price="${it.price||fd.get('price')}" data-description="${(it.description||'').replace(/"/g,'&quot;')}"><i class="fas fa-edit"></i></button> <button class="btn btn-sm btn-danger delete-item" data-id="${it.id}"><i class="fas fa-trash"></i></button></td>`;
            tbody.prepend(tr);
            document.querySelector('#addItemModal .btn-close').click();
            form.reset();
            attachRowHandlers(tr);
        }

        async function updateItem(e){
            if(e) e.preventDefault();
            const form = document.getElementById('editItemForm');
            const fd = new FormData(form);
            const id = form.querySelector('input[name="id"]').value;
            const res = await fetch(`/admin/items/${id}`,{method:'PUT', body: fd});
            const data = await res.json();
            if(!data.success) return alert(data.error||'Failed to update item');
            const it = data.item || {};
            const row = [...document.querySelectorAll('table tbody tr')].find(r => r.querySelector('td')?.textContent.trim() === String(it.id));
            if(row){
                const tds = row.querySelectorAll('td');
                tds[1].textContent = it.name ?? tds[1].textContent;
                tds[2].textContent = it.category_name ?? tds[2].textContent;
                tds[3].textContent = it.subcategory_name ?? tds[3].textContent;
                tds[4].textContent = `₹ ${Number(it.price ?? tds[4].textContent.replace('₹','')).toFixed(2)}`;
                if(it.image){
                    tds[5].innerHTML = `<img src="${normalizeItemImg(it.image)}" alt="${it.name}" style="max-width:80px; max-height:80px; object-fit:cover;" onerror="this.onerror=null; this.src='/images/placeholder.png'">`;
                }
                const toggle = row.querySelector('.item-status-toggle');
                const label = toggle.nextElementSibling;
                if(it.status){ toggle.checked = it.status==='available'; label.textContent = it.status; }
            }
            document.querySelector('#editItemModal .btn-close').click();
        }

        document.getElementById('saveItem').addEventListener('click', createItem);
        document.getElementById('addItemForm').addEventListener('submit', createItem);
        document.getElementById('updateItem').addEventListener('click', updateItem);
        document.getElementById('editItemForm').addEventListener('submit', updateItem);

        document.querySelectorAll('.edit-item').forEach(btn => {
            btn.addEventListener('click', () => {
                const f = document.getElementById('editItemForm');
                f.querySelector('input[name="id"]').value = btn.dataset.id;
                f.querySelector('input[name="name"]').value = btn.dataset.name;
                f.querySelector('select[name="subcategory_id"]').value = btn.dataset.subcategory;
                f.querySelector('input[name="price"]').value = btn.dataset.price;
                f.querySelector('textarea[name="description"]').value = btn.dataset.description || '';
                new bootstrap.Modal(document.getElementById('editItemModal')).show();
            });
        });

        function attachRowHandlers(row){
            const editBtn = row.querySelector('.edit-item');
            if(editBtn){
                editBtn.addEventListener('click', () => {
                    const f = document.getElementById('editItemForm');
                    f.querySelector('input[name="id"]').value = editBtn.dataset.id;
                    f.querySelector('input[name="name"]').value = editBtn.dataset.name;
                    f.querySelector('select[name="subcategory_id"]').value = editBtn.dataset.subcategory;
                    f.querySelector('input[name="price"]').value = editBtn.dataset.price;
                    f.querySelector('textarea[name="description"]').value = editBtn.dataset.description || '';
                    new bootstrap.Modal(document.getElementById('editItemModal')).show();
                });
            }
            const delBtn = row.querySelector('.delete-item');
            if(delBtn){
                delBtn.addEventListener('click', async () => {
                    if(!confirm('Delete this item?')) return;
                    const res = await fetch(`/admin/items/${delBtn.dataset.id}`,{method:'DELETE'});
                    const data = await res.json();
                    if(data.success){ row.remove(); } else { alert(data.error||'Failed to delete'); }
                });
            }
            const toggle = row.querySelector('.item-status-toggle');
            if(toggle){
                toggle.addEventListener('change', async (e) => {
                    const id = e.target.dataset.id;
                    const status = e.target.checked ? 'available' : 'unavailable';
                    const res = await fetch(`/admin/items/${id}/toggle-status`,{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status})});
                    const data = await res.json();
                    if(!data.success){ alert(data.error||'Failed to update status'); e.target.checked = !e.target.checked; return; }
                    e.target.nextElementSibling.textContent = status;
                });
            }
        }

        document.querySelectorAll('table tbody tr').forEach(attachRowHandlers);
    </script>
</body>
</html>


